# Сервис  анализирует всплески данных от полученных гистограмм 

Сервис читает parquet файл находящийся в hdfs хранилище. Считает количество данных за два интервала времени (за текущий момент и некоторое время назад), сравнивает их и при привышении данных в текущий момент формирует файл с правилами. 
В consul хранятся префиксы по которым необходимо отслеживать "всплески"

### Требования
1. Apache Spark https://spark.apache.org/downloads.html
2. Apache Hadoop https://hadoop.apache.org/releases.html



### Библиотеки (на всех серверах кластера)
```
pip install pyspark
pip install configparser
pip install python-consul

```

### Параметры конфигурационного файла (histogramm.conf)
**[hdfs]** - Раздел относящийся к hadoop кластеру

**host** - ip адрес или днс имя сервера на котором запущен hadoop

**port** - порт который слушает  hadoop

**file_dir** - директория где будут храниться parquet файлы 

**[logs]**

**log_path** - директория для хранения логов 

**log_file_name** - имя файла логов (незабываем выставлять права)


**[spark]**

**spark_host** = ip адрес или днс имя сервера на котором запущен spark

**spark_port** = порт который слушает  spark

**cluster_gbmemmory** = количество ОЗУ выделяемое на кластере для  проведения расчетов

**cluster_countproc** = количество cores выделяемое на кластере для  проведения расчетов

**app_name** = Имя процесса отображаемое в кластере spark 

**[other]** 

**sleepInterval** - частота запуска расчета в секнудах

**LimitNewData** - величина для новых данных которых небыло в предыдущий интервал времени для префикса /32. Привышении данного параметра сигнал для формирования файла правил.

**LimitNewDataNet** - величина для новых данных которых небыло в предыдущий интервал времени для префикса /24. Привышении данного параметра сигнал для формирования файла правил.

**quotientAmplification** - величина "всплеска" (частное) - во сколько раз текущие данные за текущиее время превышают данные за предыдущий интервал времени.  Привышении данного параметра сигнал для формирования файла правил.

**LimitDetectTimeSec** - Время в течении которого храним в памяти параметры обнаруженного "всплеска", чтобы избежать повторного формирования файла правил.

### Принцип работы

При считывании parquet файла создается DataFrame. Весь анализ проводится в DataFrame. 
Заголовки DataFrame:
- **type_proto** - Тип протокола

|условное значение|Обозначение  |
|-----------------|-------------|
|     11          |длина пакета |
|     31          |L3 SRC       |
|     32          |L3 DST       |
|     41          |L4 SRS       |
|     42          |L4 DST       |


- **num_protocol** - значение протокола (номер порта/длина пакета)

- **dst_ip** - ip адрес назначения. Представлен в формате integer

- **sum_val** - средний показатель за выбранное время

1. Пример датафрейма без "всплеска" с данными за два промежутка времени (слева текущий, справа некоторое время назад)

|num_protocol|type_proto|sum_val|   dst_ip|num_protocol|type_proto|sum_val|   dst_ip|
|------------|----------|-------|---------|------------|----------|-------|---------|
|       65535|        41|    169|174327308|       65535|        41|    179|174327308|
|        2888|        32|    176|174327315|        2888|        32|    182|174327315|
|       65535|        41|    169|174327411|       65535|        41|    179|174327411|
|          68|        11|    173|174327451|          68|        11|    173|174327451|
|       65535|        41|    169|174327315|       65535|        41|    179|174327315|
|       65535|        42|   1745|174327315|       65535|        42|   1737|174327315|


2. В слудующем датафрейме показано появление данных которых не было некоторое время назад. Эти данные попадут в функцию формирования файла правил если sum_val превышает значение переменной из конфигурационного файла **LimitNewData**

|num_protocol|type_proto|sum_val|   dst_ip|num_protocol|type_proto|sum_val|   dst_ip|
|------------|----------|-------|---------|------------|----------|-------|---------|
|       65535|        41|    169|174327308|       65535|        41|    160|174327308|
|        2888|        32|    182|174327315|        2888|        32|    172|174327315|
|       65535|        41|    169|174327411|       65535|        41|    160|174327411|
|          68|        11|    174|174327451|          68|        11|    170|174327451|
|       65535|        41|    169|174327315|       65535|        41|    160|174327315|
|          68|        11|    175|174327454|        **null**|      **null**|   **null**|     **null**|
|       65535|        42|   1729|174327315|       65535|        42|   1770|174327315|
|          65|        11|    174|174327451|          65|        11|    173|174327451|
|          65|        11|    174|174327308|          65|        11|    173|174327308|
|        2777|        31|    151|174327451|        2777|        31|    140|174327451|
|       65535|        41|    175|174327454|        **null**|      **null**|   **null**|     **null**|


3. В слудующем датафрейме показан "всплеск" данных. Эти данные попадут в функцию формирования файла правил если частное sum_val левой и правой части датафрейма превышает значение переменной из конфигурационного файла **quotientAmplification**

|num_protocol|type_proto|sum_val|   dst_ip|num_protocol|type_proto|sum_val|   dst_ip|
|------------|----------|-------|---------|------------|----------|-------|---------|
|          65|        11|    **961**|174327451|          65|        11|    174|174327451|
|          68|        11|    **1300**|174327451|          68|        11|    174|174327451|
|        2777|        31|    148|174327451|        2777|        31|    150|174327451|
|        2888|        32|    173|174327451|        2888|        32|    171|174327451|
|       65535|        41|    171|174327451|       65535|        41|    173|174327451|
|       65535|        42|   1739|174327451|       65535|        42|   1755|174327451|
